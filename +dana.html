<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartWallet - Wallet Cerdas dengan Account Abstraction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Semua CSS sebelumnya tetap sama */
        /* ... */
        
        /* Tambahan untuk loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 24px;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>Menginisialisasi wallet...</div>
    </div>

    <!-- Semua elemen UI sebelumnya tetap sama -->
    <!-- ... -->

    <script type="module">
        // Konfigurasi Supabase
        const SUPABASE_URL = 'https://your-project-id.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        
        // Inisialisasi Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State aplikasi
        let userAddress = null;
        let smartAccountAddress = null;
        let session = null;
        
        // Elemen UI
        const balanceAmountEl = document.getElementById('balanceAmount');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Fungsi untuk menampilkan/menyembunyikan loading
        function showLoading(message) {
            if (message) loadingOverlay.querySelector('div:last-child').textContent = message;
            loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Inisialisasi wallet dengan Metamask
        async function initWallet() {
            showLoading('Menginisialisasi wallet...');
            
            try {
                // Periksa apakah Metamask terinstall
                if (!window.ethereum) {
                    throw new Error('Silakan install Metamask untuk menggunakan wallet ini!');
                }
                
                // Minta koneksi ke wallet
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                // Dapatkan session token dari Supabase
                const { data, error } = await supabase.functions.invoke('create-session', {
                    body: { userAddress }
                });
                
                if (error) throw error;
                
                session = data.session;
                smartAccountAddress = data.smartAccountAddress;
                
                // Perbarui UI
                updateBalances();
                
                console.log('Smart Account Address:', smartAccountAddress);
                console.log('User Address:', userAddress);
                
                hideLoading();
                showNotification('Wallet Connected', `Smart wallet berhasil diinisialisasi!`);
                
            } catch (error) {
                console.error('Error initializing wallet:', error);
                hideLoading();
                showNotification('Wallet Error', `Gagal menginisialisasi wallet: ${error.message}`);
            }
        }
        
        // Perbarui saldo wallet melalui Supabase
        async function updateBalances() {
            showLoading('Memperbarui saldo...');
            
            try {
                // Panggil fungsi Supabase untuk mendapatkan saldo
                const { data, error } = await supabase.functions.invoke('get-balances', {
                    headers: {
                        'Authorization': `Bearer ${session.token}`
                    }
                });
                
                if (error) throw error;
                
                const { ethBalance, tokenBalance } = data;
                
                // Konversi ke Rupiah (contoh kurs)
                const ethToIDR = 24000000; // 1 ETH = 24,000,000 IDR
                const balanceInIDR = (parseFloat(ethBalance) * ethToIDR).toLocaleString('id-ID');
                
                balanceAmountEl.textContent = `Rp ${balanceInIDR}`;
                
                console.log(`ETH Balance: ${ethBalance}`);
                console.log(`Token Balance: ${tokenBalance} NYMPH`);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error updating balances:', error);
                hideLoading();
                showNotification('Error', `Gagal memperbarui saldo: ${error.message}`);
            }
        }
        
        // Kirim transaksi melalui Supabase
        async function sendTransaction(recipient, amount) {
            showLoading('Mengirim transaksi...');
            
            try {
                // Validasi input
                if (!recipient || !recipient.startsWith('0x') || recipient.length !== 42) {
                    throw new Error('Alamat penerima tidak valid');
                }
                
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Jumlah tidak valid');
                }
                
                // Panggil fungsi Supabase untuk mengirim transaksi
                const { data, error } = await supabase.functions.invoke('send-transaction', {
                    body: { 
                        recipient, 
                        amount: amount.toString(),
                        userAddress
                    },
                    headers: {
                        'Authorization': `Bearer ${session.token}`
                    }
                });
                
                if (error) throw error;
                
                // Perbarui saldo
                await updateBalances();
                
                // Tampilkan notifikasi
                showNotification('Transfer Berhasil', `Berhasil mengirim ${amount} ETH ke ${recipient.substring(0, 8)}...`);
                
                return data.txHash;
                
            } catch (error) {
                console.error('Transaction failed:', error);
                showNotification('Error', `Gagal mengirim transaksi: ${error.message}`);
                return null;
            } finally {
                hideLoading();
            }
        }
        
        // Isi saldo melalui Supabase
        async function topUpWallet(amount) {
            showLoading('Mengisi saldo...');
            
            try {
                // Validasi input
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Jumlah tidak valid');
                }
                
                // Panggil fungsi Supabase untuk mint token
                const { data, error } = await supabase.functions.invoke('mint-tokens', {
                    body: { 
                        amount: amount.toString(),
                        userAddress
                    },
                    headers: {
                        'Authorization': `Bearer ${session.token}`
                    }
                });
                
                if (error) throw error;
                
                // Perbarui saldo
                await updateBalances();
                
                // Tampilkan notifikasi
                showNotification('Isi Saldo Berhasil', `Berhasil menambahkan ${amount} NYMPH ke wallet`);
                
                return data.txHash;
                
            } catch (error) {
                console.error('Top-up failed:', error);
                showNotification('Error', `Gagal mengisi saldo: ${error.message}`);
                return null;
            } finally {
                hideLoading();
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', initWallet);
        
        // ... (event listeners lainnya tetap sama)
        
    </script>
</body>
</html>